import{a as b}from"./chunk-RNWIIYZZ.js";import{a as u}from"./chunk-SUAWKU6Z.js";import{a as p,b as f}from"./chunk-J2MKRRCW.js";import{G as l,H as m}from"./chunk-M65M2HHG.js";import{Da as n,X as c,aa as a,g as h}from"./chunk-ZKAUCJHV.js";import{h as d}from"./chunk-DEPBX7UX.js";var P=(()=>{let s=class s{constructor(e,t,o,i,g,v){this.dbs=e,this.ms=t,this.sbs=o,this.bs=i,this.es=g,this.ds=v,this.onCancelEditing=new n,this.onNewWidget=new n,this.onEditedWidgetChanged=new n,this.onSave=new n,this.onUnsavedChanged=new h(!1),this.onDeleteWidget=new n}resetSavedState(){this.onUnsavedChanged.next(!1)}unsaved(){this.onUnsavedChanged.next(!0)}getWidgetsList(e=[],t=!0){let o=this.dbs.getWidgetsWithoutEmpty(e).map(i=>({name:i.name,label:i.name+(i.title?` (${i.title})`:"")}));return t?[{label:"",name:""},...o]:o}updateEditedWidget(e){this.unsaved(),e.reCreate&&(e.widget.edKey="ed"+new Date().getTime()),this.onEditedWidgetChanged.emit(e)}cancelEditing(){this.onCancelEditing.emit(),this.resetSavedState()}save(e){if(this.validate(e)){if(this.dbs.generateDisplayInfo(e),!e.dashboard){console.error("no dashboard specified in widget:",e);return}this.ds.saveWidget(e.dashboard,e,e?.oldWidget?.name).then(t=>{this.dbs.saveWidgetPositionAndSize(e),this.onSave.emit(),this.sbs.hide(),this.resetSavedState(),this.bs.broadcast("refresh-dashboard")}).catch(t=>{})}}generateWidgetMdx(e){return d(this,null,function*(){if(e.mdx="",e.kpiclass="",e.kpitype="",!e.dataSource)return;let t=e.dataSource.split(".");if(t.pop()?.toLowerCase()==="kpi")e.kpiclass=t.join("."),e.kpitype="sql";else{let i=yield this.ds.getPivotData(e.dataSource);i&&(e.mdx=i.mdx||"")}})}deleteWidget(e){let t=()=>{this.onDeleteWidget.emit(e),this.sbs.hide()};this.askForWidgetDeletion(e,()=>{e.oldWidget?this.ds.deleteWidget(e.dashboard,e.oldWidget.name).then(()=>{t()}):t()})}navigateDataSourceAndType(e,t=[]){this.sbs.showComponent({component:import("./chunk-OSS5E7PX.js"),single:!0,inputs:{model:e,invalid:t}})}askForWidgetDeletion(e,t){this.ms.show({message:`Do you really want do delete widget "${e.name}"?`,buttons:[{label:"No",autoClose:!0},{label:"Yes",default:!0,autoClose:!0,click:t}]})}validate(e){if(!e.name){this.es.show("Please enter widget name",!0),this.sbs.showComponent({component:import("./chunk-2WNVZACP.js"),single:!0,inputs:{invalid:["name"]}});return}if(!e.dataSource&&!e.dataLink){this.es.show('Please choose "Data source" or "Reference to"',!0),this.navigateDataSourceAndType(e,["datasource"]);return}return!0}};s.\u0275fac=function(t){return new(t||s)(a(f),a(b),a(u),a(p),a(l),a(m))},s.\u0275prov=c({token:s,factory:s.\u0275fac,providedIn:"root"});let r=s;return r})();export{P as a};
