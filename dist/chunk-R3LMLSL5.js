import{a as D,b as E}from"./chunk-CF2VGD6U.js";import{E as I,H as F,I as S,J as b,u as y}from"./chunk-GDT23CSW.js";import{X as x,aa as h,za as m}from"./chunk-ZEAAPN4P.js";var A="%ZEN.Component.calendar",N=(()=>{class c{constructor(e,r,i,t,s,l,n){this.route=e,this.us=r,this.ss=i,this.ds=t,this.bs=s,this.dbs=l,this.i18n=n,this.filtersChanged=!1,this.isFiltersOnToolbarExists=!1,this.items=[],this.onApplyFilter=new m,this.onFiltersChanged=new m,this.dashboard=""}init(e,r){this.filtersChanged=!0,this.dashboard=r,this.items=[],this.isFiltersOnToolbarExists=!1;for(let i=0;i<e.length;i++){this.items.push(e[i]);let t=this.items[this.items.length-1];if(t.isDate=t.controlClass===A||t.targetPropertyDataType==="%DeepSee.Time.DayMonthYear",t.isDate&&(t.values=[]),this.checkForExclude(t),t.value&&t.value?.toString().charAt(0)==="{"){t.value=t.value.toString().slice(1,-1);let s=t.value.toString().split(",");t.value=t.value.toString().replace(/,/g,"|")}if(t.valueList&&t.displayList){let s=t.valueList.split(","),l=t.displayList.split(",");t.values=[];for(let n=0;i<s.length;n++)t.values.push({name:l[n],path:s[n]})}if(t.value?.toString().indexOf(":")!==-1)if(t.isDate)this.initDateFilter(t);else{let s=t.value?.toString().split(":");t.fromIdx=t.values.findIndex(l=>l.path===s[0])||-1,t.toIdx=t.values.findIndex(l=>l.path===s[1])||-1,t.fromIdx===-1&&(t.values?.push({path:s[0],name:s[0].replace("&[","").replace("]","")}),t.fromIdx=t.values.length-1),t.values[t.fromIdx].checked=!0,t.toIdx===-1&&(t.values.push({path:s[1],name:s[1].replace("&[","").replace("]","")}),t.toIdx=t.values.length-1),t.values[t.toIdx].checked=!0,t.isInterval=!0}if(t.targetArray=[],t.target!=="*"&&t.target!==""&&(t.targetArray=t.target?.split(",").concat(["emptyWidget"])),t.sourceArray=[],t.source!=="*"&&t.source!==""&&t.location!=="dashboard"&&(t.sourceArray=t.source?.split(",")),(t.source===""||t.location==="dashboard")&&(this.isFiltersOnToolbarExists=!0),t.label){let s=t.label.match(/(\/\*([^*]|[\r\n]|(\*+([^*\/]|[\r\n])))*\*+\/)|(\/\/.*)/g);if(s&&s.length!==0){let l=s[0].substring(2,s[0].length-2);t.additionalParams=l.toLowerCase().trim().split(","),t.additionalParams.indexOf("inverseorder")!==-1&&(t.values=t.values?.reverse()),t.additionalParams.indexOf("ignorenow")!==-1&&(t.values=t.values?.filter(n=>n.path.toLowerCase()!=="&[now]"))}t.label=t.label.replace(/(\/\*([^*]|[\r\n]|(\*+([^*\/]|[\r\n])))*\*+\/)|(\/\/.*)/g,"")}this.route.snapshot.queryParamMap.get("nofilters")==="1"&&(t.value=""),t.valueDisplay=this.findDisplayText(t)}this.loadFiltersFromSettings(),this.loadFiltersFromUrl()}getFiltersShareUrl(){let e=window.location.href.split("?")[0],r=e.split("#")[1],i=this.getFiltersUrlString(),t="FILTERS=TARGET:*;FILTER:"+i;return i&&(r&&r.indexOf("?")!==-1?e+="&"+t:e+="?"+t),e}getFiltersUrlString(e,r=!1,i=".",t="~"){let s=[],l=e?this.getAffectsFilters(e):this.items;r&&l&&(l=l.filter(n=>n.target!=="*"));for(let n=0;n<l.length;n++){let a=l[n];if(!a.value&&!a.isInterval)continue;let o="";a.isInterval?o=a.targetProperty+i+a.values?.[a.fromIdx]?.path+":"+a.values?.[a.toIdx]?.path:o=a.targetProperty+i+(a.isExclude?"%NOT ":"")+a.value,o.indexOf("|")!==-1&&(o=o.replace(/\|/g,",").replace("&[","{&[")+"}"),s.push(o)}return encodeURIComponent(s.join(t))}loadFiltersFromUrl(){if(this.route.snapshot.queryParamMap.get("nofilters")==="1")return;let e=window.location.hash.split("?")[1];if(!e)return;e=e.replace(/\.&%5B/g,".%26%5B"),e=e.replace(/\.=&%5B/g,".%26%5B"),e=e.replace(/\.%7B=&%5B/g,".%7B%26%5B"),e=e.replace(/\,=&%5B/g,",%26%5B"),e=e.replace(/\.&\[/g,".%26%5B"),e=e.replace(/\.=&\[/g,".%26%5B");let r=e.split("&"),i="";r.forEach(a=>{a.split("=")[0].toLowerCase()==="filters"&&(i=a.split("=")[1])});try{let a=decodeURIComponent(i);this.isBase64(a)&&(i=atob(a))}catch{}if(!i){let a=Object.keys(this.route.snapshot.queryParams)[0];if(!a||(i=a.split("FILTERS=")[1],!i))return}let t=i.split(";"),s="",l="";for(let a=0;a<t.length;a++){let o=t[a].split(":");if(o[0].toLowerCase()==="target"){s=o[1];continue}o[0].toLowerCase()==="filter"&&(l=o.slice(1).join(":"))}let n=[];s!=="*"?n=this.items.filter(a=>a.targetArray?.indexOf(s)!==-1||a.target===s||a.target==="*"):n=this.items.slice(),n.forEach((a,o)=>{let p=decodeURIComponent(l).split("~");for(let d=0;d<p.length;d++){let u=decodeURIComponent(p[d]);if(u.charAt(u.length-1)==="="&&(u=u.slice(0,-1)),a.isDate){let v=u.split(".&");if(v[0]!==a.targetProperty)continue;a.value="&"+v[1],this.initDateFilter(a)}if(u.indexOf("{")!==-1){if(u.substring(0,u.indexOf("{")-1).replace("%NOT ","")!==a.targetProperty)continue;let g=u.match(/\{([^)]+)\}/)?.[1].split(",");a.value=g?.join("|")}else{if(u.split(".&")[0]!==a.targetProperty)continue;if(u.indexOf(":")!==-1){let g=u.split(":"),w=g[0].split(".").pop(),T=g[1];a.fromIdx=a.values.findIndex(f=>f.path===w),a.toIdx=a.values.findIndex(f=>f.path===T),a.isInterval=!0}else a.value="&"+u.split(".&")[1]}}a.valueDisplay=this.findDisplayText(a)})}getClickFilterTarget(e){let r=[];for(let i=0;i<this.items.length;i++){let t=this.items[i];t.location==="click"&&(t.source?.toLowerCase()===e.toLowerCase()||t.source==="*")&&r.push(t.target||"")}return r}getAffectsFilters(e){return this.items.filter(r=>r.target==="*"||r.target===e||r.targetArray?.indexOf(e)!==-1)}findDisplayText(e){if(e.value===""||e.value===void 0)return"";let r=e.value,i=!1;if(typeof r=="string"&&(i=r.toString().toUpperCase().endsWith(".%NOT")),i&&(r=r.toString().substr(0,r.toString().length-5)),e.isDate)return this.findDateText(e);e.value=r;let t=e.value.toString().split("|"),s=[];for(let l=0;l<e.values.length;l++)(e.values[l].path===r||t.length>1&&t.includes(e.values[l].path))&&(e.values[l].checked=!0,e.values[l].default=!0,e.defaultExclude=i,e.isExclude=i,s.push(e.values[l].name.toString()));return(e.isExclude?"Not ":"")+s.join(",")}getWidgetModelFilters(e){let r=[];for(let i=0;i<this.items.length;i++)if(this.items[i].type!=="hidden"&&this.items[i].location!=="click"){if(e==="emptyWidget"&&(this.items[i].source===""||this.items[i].location==="dashboard")){r.push({idx:i,label:this.items[i].label,text:this.items[i].valueDisplay,info:this.items[i].info});continue}this.items[i].location!=="dashboard"&&(this.items[i].source==="*"||this.items[i].sourceArray?.indexOf(e)!==-1)&&r.push({idx:i,label:this.items[i].label,text:this.items[i].valueDisplay,info:this.items[i].info})}return r}getWidgetFilters(e){let r=[];for(let i=0;i<this.items.length;i++)(this.items[i].target==="*"||this.items[i].target===""||this.items[i].targetArray?.indexOf(e)!==-1)&&r.push(this.items[i]);return r}applyFilter(e,r){this.onApplyFilter.emit(e);let i="",t="",s;for(s=0;s<e.values.length;s++)e.values[s].checked&&(i+=e.values[s].name+",",t+=e.values[s].path+"|");if(i!==""&&(i=i.substr(0,i.length-1)),t!==""&&(t=t.substr(0,t.length-1)),e.isDate&&(i=i.replace(","," - ")),e.isExclude&&(i=this.i18n.get("not")+" "+i),e.isInterval&&(i=(e.values[e.fromIdx]?.name?.toString()||"")+":"+(e.values[e.toIdx]?.name?.toString()||"")),e.valueDisplay=i,e.value=t,!r){if(e.action!=="setFilter")if(e.targetArray.length!==0)for(s=0;s<e.targetArray.length;s++)this.bs.broadcast("filter"+e.targetArray[s],e);else(e.target==="*"||e.target==="")&&this.bs.broadcast("filterAll",e);if(e.sourceArray.length!==0)for(s=0;s<e.sourceArray.length;s++)this.bs.broadcast("updateFilterText"+e.sourceArray[s],e)}this.filtersChanged=!0,this.saveFilters(),this.updateFiltersParameterInURL(),this.onFiltersChanged.emit()}saveFilters(){if(this.ss.getAppSettings().isSaveFilters===!1)return;let r,i,t=[];for(r=0;r<this.items.length;r++)i=this.items[r],(i.value!==""||i.isInterval)&&t.push(i);let s=t.map(n=>({targetProperty:n.targetProperty,value:n.value,isExclude:n.isExclude,isInterval:n.isInterval,fromIdx:n.fromIdx,toIdx:n.toIdx,valueDisplay:n.valueDisplay})),l=this.ss.getWidgetsSettings(this.dashboard);s.length?l._filters=s:delete l._filters,this.ss.setWidgetsSettings(l,this.dashboard)}getFilter(e){if(this.items[e])return this.items[e]}clear(){this.items=[]}removeParameterFromUrl(e,r){return e.replace(new RegExp("[?&]"+r+"=[^&#]*(#.*)?$"),"$1").replace(new RegExp("([?&])"+r+"=[^&]*&"),"$1")}isBase64(e){try{return btoa(atob(e))===e}catch{return!1}}loadFiltersFromSettings(){if(this.route.snapshot.queryParamMap.get("nofilters")==="1"||this.us.isEmbedded()||this.ss.getAppSettings()?.isSaveFilters===!1)return;let e=!1,r=this.ss.getWidgetsSettings(this.dashboard);if(r._filters)for(let i=0;i<r._filters.length;i++){let t=r._filters[i],s=this.items.filter(l=>l.targetProperty===t.targetProperty)[0];if(s){if(s.value=t.value,s.isExclude=t.isExclude,s.isInterval=t.isInterval,s.isInterval)s.fromIdx=t.fromIdx,s.toIdx=t.toIdx,s.isDate?(s.valueDisplay=t.valueDisplay,s.values=t.value.toString().split("|").map(l=>({path:l,checked:!0}))):s.valueDisplay=s.values?.[s.fromIdx]?.name+":"+s.values?.[s.toIdx]?.name;else{let l=t.value.toString().split("|");s.values?.forEach(n=>{l.indexOf(n.path.toString())!==-1&&(n.checked=!0)}),this._addSavedFilterToFilterList(t,s),t.valueDisplay&&(s.valueDisplay=t.valueDisplay.trim()),s.valueDisplay||(s.valueDisplay=t.value.toString().split("|").map(n=>{let a=n.indexOf(".%NOT")!==-1;a&&(n=n.replace(".%NOT",""));let o=s.values?.find(d=>d.path==n),p="";return o&&o.name&&(p=o.name.toString()),(a?this.i18n.get("not")+" ":"")+p}).join(","))}e=!0}}}updateFiltersParameterInURL(){if(!this.us.isEmbedded())return;let e=this.route.snapshot.queryParamMap.get("widget")||-1;if(e===-1)return;let r=this.dbs.getAllWidgets()[parseInt(e,10)],i=r?.name,t="TARGET:*;FILTER:"+this.getFiltersUrlString(i,!0);this.ds.router.navigate([],{relativeTo:this.route,queryParams:{FILTERS:t},queryParamsHandling:"merge"});let s={type:"filter",index:this.route.snapshot.queryParamMap.get("widget"),widget:r,filters:t};window.parent&&window.parent.postMessage(s,"*");try{window.parent.dsw?.onFilter&&window.parent.dsw.onFilter(s)}catch(l){console.error(l)}}_addSavedFilterToFilterList(e,r){let i=e.value.toString().split("|");if(!i.length||!e.valueDisplay)return;let t=e.valueDisplay.toString().split(",");i.forEach((s,l)=>{r.values.some(n=>n.path===s||!isNaN(n.path)&&parseInt(s,10)===n.path)||r.values.push({name:t[l],path:s,checked:!0,_saved:!0})})}initDateFilter(e){e.isInterval=!0,e.value=e.value.toString().replace(":","|");let r=e.value.toString().split("|");e.values||(e.value=[]),e.values.forEach(i=>i.checked=!1),e.fromIdx=e.values.findIndex(i=>i.path===r[0]),e.fromIdx===-1&&(e.values.push({path:r[0]}),e.fromIdx=e.values.length-1),e.values[e.fromIdx].checked=!0,e.toIdx=e.values.findIndex(i=>i.path===r[1]),e.toIdx===-1&&(e.values.push({path:r[1]}),e.toIdx=e.values.length-1),e.values[e.toIdx].checked=!0}findDateText(e){return(e.value||"").toString().split("|").map(i=>i.replace("&[","").replace("]","")).join(":")}checkForExclude(e){if(e.isExclude=(e.value??"").toString().toLowerCase().startsWith("%not"),!e.isExclude)return;let r=e.value.split(" ")[1];if(!r)return;let i=e.values?.find(t=>t.path===r);i&&(e.value=i.path+".%NOT")}static{this.\u0275fac=function(r){return new(r||c)(h(y),h(S),h(b),h(F),h(D),h(E),h(I))}}static{this.\u0275prov=x({token:c,factory:c.\u0275fac,providedIn:"root"})}}return c})();export{N as a};
